<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å®¶åº­ç¯®çƒè·‘é…·</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<style>
html,body{
  margin:0;padding:0;overflow:hidden;
  background:#1a237e;color:#fff;
  font-family:"Microsoft YaHei",sans-serif;
}
#ui{
  position:absolute;top:0;left:0;right:0;
  text-align:center;z-index:10;
  padding:15px;
  background:rgba(0,0,0,0.6);
}
button{
  padding:12px 28px;
  font-size:16px;
  border:none;border-radius:25px;
  background:#ff4081;color:#fff;
  margin:5px;
  cursor:pointer;
  transition:transform 0.2s;
}
button:hover{
  transform:scale(1.05);
}
#characterSelect{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.9);
  padding:30px;
  border-radius:20px;
  z-index:20;
  display:none;
}
.charOption{
  display:inline-block;
  margin:15px;
  text-align:center;
  cursor:pointer;
  padding:15px;
  border-radius:15px;
  transition:all 0.3s;
}
.charOption:hover{
  background:rgba(255,64,129,0.3);
}
.charOption img{
  width:80px;height:80px;
  border-radius:50%;
  margin-bottom:10px;
}
.stats{
  position:absolute;
  top:20px;right:20px;
  background:rgba(0,0,0,0.7);
  padding:15px;
  border-radius:15px;
  font-size:14px;
}
</style>
</head>
<body>

<div id="ui"></div>
<div id="characterSelect"></div>
<canvas id="game"></canvas>

<script>
/* ===== Canvas ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize(); onresize = resize;

/* ===== æ¸¸æˆçŠ¶æ€ ===== */
let state = "start";
let score = 0;
let best = localStorage.bestScore || 0;
let speed = 4;
let frame = 0;
let selectedCharacter = "çˆ¸çˆ¸";
let difficultyLevel = 1;
let obstacleSpawnRate = 0.18;
let lastBonusTime = 0;

/* ===== åŸå¸‚èƒŒæ™¯ ===== */
const buildings = [];
function initBuildings() {
  buildings.length = 0;
  for(let i = 0; i < 20; i++) {
    buildings.push({
      x: Math.random() * canvas.width,
      width: 50 + Math.random() * 100,
      height: 100 + Math.random() * 300,
      color: `hsl(${220 + Math.random() * 40}, 60%, ${30 + Math.random() * 30}%)`,
      windows: Math.floor(Math.random() * 10) + 5
    });
  }
}
initBuildings();

/* ===== è§’è‰²å®šä¹‰ ===== */
const characters = {
  "çˆ¸çˆ¸": {
    color: "#FF9800",
    width: 60,
    height: 70,
    special: "doubleJump", // å¯ä»¥äºŒæ®µè·³
    draw: function(x, y, jumping, frame) {
      ctx.save();
      ctx.fillStyle = this.color;
      
      // èƒ–èƒ–çš„èº«ä½“
      ctx.beginPath();
      ctx.ellipse(x, y-20, 25, 35, 0, 0, Math.PI*2);
      ctx.fill();
      
      // å¤´éƒ¨
      ctx.beginPath();
      ctx.arc(x, y-55, 18, 0, Math.PI*2);
      ctx.fill();
      
      // çœ¼ç›
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.arc(x-6, y-58, 3, 0, Math.PI*2);
      ctx.arc(x+6, y-58, 3, 0, Math.PI*2);
      ctx.fill();
      
      // å˜´å·´
      ctx.beginPath();
      ctx.arc(x, y-50, 8, 0.1, Math.PI-0.1);
      ctx.stroke();
      
      // æ‰‹è‡‚
      ctx.lineWidth = 8;
      ctx.lineCap = "round";
      ctx.strokeStyle = this.color;
      ctx.beginPath();
      ctx.moveTo(x-30, y-30);
      ctx.lineTo(x-15, y-25);
      ctx.stroke();
      
      ctx.beginPath();
      ctx.moveTo(x+30, y-30);
      ctx.lineTo(x+15, y-25);
      ctx.stroke();
      
      // ç¯®çƒ
      const ballY = jumping ? y-15 : y+5;
      ctx.fillStyle = "#ff5722";
      ctx.beginPath();
      ctx.arc(x+25, ballY, 10, 0, Math.PI*2);
      ctx.fill();
      
      // ç¯®çƒçº¹è·¯
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x+15, ballY);
      ctx.lineTo(x+35, ballY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x+25, ballY-10);
      ctx.lineTo(x+25, ballY+10);
      ctx.stroke();
      
      ctx.restore();
    }
  },
  "lucky": {
    color: "#4CAF50",
    width: 45,
    height: 55,
    special: "fast", // ç§»åŠ¨æ›´å¿«
    draw: function(x, y, jumping, frame) {
      ctx.save();
      ctx.fillStyle = this.color;
      
      // èº«ä½“
      ctx.beginPath();
      ctx.ellipse(x, y-15, 15, 20, 0, 0, Math.PI*2);
      ctx.fill();
      
      // å¤´éƒ¨
      ctx.beginPath();
      ctx.arc(x, y-40, 12, 0, Math.PI*2);
      ctx.fill();
      
      // çœ¼ç›ï¼ˆæ›´å¤§æ›´å¯çˆ±ï¼‰
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.arc(x-4, y-42, 4, 0, Math.PI*2);
      ctx.arc(x+4, y-42, 4, 0, Math.PI*2);
      ctx.fill();
      
      // å˜´å·´å¾®ç¬‘
      ctx.beginPath();
      ctx.arc(x, y-36, 6, 0.2, Math.PI-0.2);
      ctx.stroke();
      
      // å¸½å­
      ctx.fillStyle = "#2196F3";
      ctx.beginPath();
      ctx.ellipse(x, y-48, 15, 8, 0, 0, Math.PI*2);
      ctx.fill();
      
      // æ‰‹è‡‚
      ctx.lineWidth = 6;
      ctx.lineCap = "round";
      ctx.strokeStyle = this.color;
      ctx.beginPath();
      ctx.moveTo(x-20, y-20);
      ctx.lineTo(x-10, y-15);
      ctx.stroke();
      
      // æŠ±ç€ç¯®çƒ
      ctx.fillStyle = "#ff5722";
      ctx.beginPath();
      ctx.arc(x+15, y-10, 8, 0, Math.PI*2);
      ctx.fill();
      
      ctx.restore();
    }
  },
  "åˆ˜å¤§åŠ›": {
    color: "#E91E63",
    width: 50,
    height: 60,
    special: "highJump", // è·³å¾—æ›´é«˜
    draw: function(x, y, jumping, frame) {
      ctx.save();
      ctx.fillStyle = this.color;
      
      // è‹—æ¡èº«ä½“
      ctx.beginPath();
      ctx.ellipse(x, y-20, 18, 25, 0, 0, Math.PI*2);
      ctx.fill();
      
      // å¤´éƒ¨
      ctx.beginPath();
      ctx.arc(x, y-48, 15, 0, Math.PI*2);
      ctx.fill();
      
      // é•¿å‘
      ctx.beginPath();
      ctx.moveTo(x-15, y-48);
      ctx.quadraticCurveTo(x-25, y-30, x-10, y-20);
      ctx.quadraticCurveTo(x, y-25, x, y-35);
      ctx.fill();
      
      // çœ¼ç›
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.arc(x-5, y-50, 3, 0, Math.PI*2);
      ctx.arc(x+5, y-50, 3, 0, Math.PI*2);
      ctx.fill();
      
      // è¾«å­è£…é¥°
      ctx.fillStyle = "#FFD700";
      ctx.beginPath();
      ctx.arc(x-12, y-45, 3, 0, Math.PI*2);
      ctx.arc(x+12, y-45, 3, 0, Math.PI*2);
      ctx.fill();
      
      // çŒç¯®åŠ¨ä½œ
      const jumpOffset = jumping ? -20 : 0;
      ctx.lineWidth = 6;
      ctx.strokeStyle = this.color;
      ctx.beginPath();
      ctx.moveTo(x-20, y-15);
      ctx.lineTo(x-10, y-5+jumpOffset);
      ctx.stroke();
      
      ctx.beginPath();
      ctx.moveTo(x+20, y-15);
      ctx.lineTo(x+10, y-5+jumpOffset);
      ctx.stroke();
      
      // æ‰‹ä¸Šçš„ç¯®çƒ
      ctx.fillStyle = "#ff5722";
      ctx.beginPath();
      ctx.arc(x+25, y+jumpOffset, 9, 0, Math.PI*2);
      ctx.fill();
      
      // çŒç¯®ç‰¹æ•ˆ
      if(jumping) {
        ctx.strokeStyle = "#FFD700";
        ctx.lineWidth = 3;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.arc(x+25, y+jumpOffset, 15, 0, Math.PI*2);
        ctx.stroke();
      }
      
      ctx.restore();
    }
  },
  "nn": {
    color: "#9C27B0",
    width: 55,
    height: 65,
    special: "slowTime", // å‡ç¼“æ—¶é—´
    draw: function(x, y, jumping, frame) {
      ctx.save();
      ctx.fillStyle = this.color;
      
      // èº«ä½“
      ctx.beginPath();
      ctx.ellipse(x, y-15, 22, 28, 0, 0, Math.PI*2);
      ctx.fill();
      
      // å¤´éƒ¨
      ctx.beginPath();
      ctx.arc(x, y-45, 16, 0, Math.PI*2);
      ctx.fill();
      
      // é“¶å‘
      ctx.fillStyle = "#FFFFFF";
      ctx.beginPath();
      ctx.ellipse(x, y-58, 20, 10, 0, 0, Math.PI*2);
      ctx.fill();
      
      // è€èŠ±é•œ
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x-8, y-43, 6, 0, Math.PI*2);
      ctx.arc(x+8, y-43, 6, 0, Math.PI*2);
      ctx.moveTo(x-2, y-43);
      ctx.lineTo(x+2, y-43);
      ctx.stroke();
      
      // æ…ˆç¥¥çš„å¾®ç¬‘
      ctx.beginPath();
      ctx.arc(x, y-35, 8, 0.1, Math.PI-0.1);
      ctx.stroke();
      
      // æ‹æ–æ‰‹è‡‚
      ctx.lineWidth = 5;
      ctx.strokeStyle = this.color;
      ctx.beginPath();
      ctx.moveTo(x-25, y-5);
      ctx.lineTo(x-10, y-10);
      ctx.stroke();
      
      // æ‹æ–
      ctx.strokeStyle = "#795548";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(x-25, y-5);
      ctx.lineTo(x-35, y+15);
      ctx.stroke();
      
      // å¦ä¸€åªæ‰‹æ‹¿ç¯®çƒ
      ctx.fillStyle = "#ff5722";
      ctx.beginPath();
      ctx.arc(x+20, y, 8, 0, Math.PI*2);
      ctx.fill();
      
      // é’ˆç»‡çº¹ç†
      ctx.strokeStyle = "#FFFFFF";
      ctx.lineWidth = 1;
      for(let i = -2; i <= 2; i++) {
        ctx.beginPath();
        ctx.arc(x+i*5, y-15, 2, 0, Math.PI*2);
        ctx.stroke();
      }
      
      ctx.restore();
    }
  }
};

/* ===== ç©å®¶ ===== */
const player = {
  lane: 0,
  y: canvas.height * 0.7,
  jumping: false,
  jumpT: 0,
  doubleJumpUsed: false,
  specialCooldown: 0
};

/* ===== è½¨é“ç³»ç»Ÿ ===== */
const lanes = [-1, 0, 1];
function laneX(l) {
  return canvas.width/2 + l * canvas.width * 0.25;
}

/* ===== ç¯®çƒä¸»é¢˜éšœç¢ç‰© ===== */
let obstacles = [];
const obstacleTypes = {
  hoop: { // ç¯®ç­
    width: 80,
    height: 60,
    color: "#FF9800",
    draw: function(x, y) {
      // ç¯®æ¿
      ctx.fillStyle = "#FFFFFF";
      ctx.fillRect(x-40, y, 80, 40);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 3;
      ctx.strokeRect(x-40, y, 80, 40);
      
      // ç¯®ç­
      ctx.fillStyle = "#FF5722";
      ctx.beginPath();
      ctx.ellipse(x, y+20, 25, 10, 0, 0, Math.PI*2);
      ctx.fill();
      
      // ç¯®ç½‘
      ctx.strokeStyle = "#78909C";
      ctx.lineWidth = 1;
      for(let i = 0; i < 8; i++) {
        ctx.beginPath();
        ctx.moveTo(x-20 + i*5, y+20);
        ctx.lineTo(x-15 + i*5, y+35);
        ctx.stroke();
      }
    },
    checkCollision: function(x, y, playerX, playerY) {
      return Math.abs(playerX - x) < 40 && 
             Math.abs(playerY - (y+20)) < 20;
    }
  },
  courtLine: { // çƒåœºçº¿
    width: canvas.width,
    height: 15,
    color: "#FFFFFF",
    draw: function(x, y) {
      ctx.strokeStyle = this.color;
      ctx.lineWidth = 5;
      ctx.setLineDash([20, 10]);
      ctx.beginPath();
      ctx.moveTo(0, y+7);
      ctx.lineTo(canvas.width, y+7);
      ctx.stroke();
      ctx.setLineDash([]);
    },
    checkCollision: function(x, y, playerX, playerY) {
      return !player.jumping && Math.abs(playerY - (y+7)) < 25;
    }
  },
  movingBall: { // ç§»åŠ¨çš„ç¯®çƒ
    width: 40,
    height: 40,
    color: "#FF5722",
    speedX: 0,
    draw: function(x, y, frame) {
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(x, y, 20, 0, Math.PI*2);
      ctx.fill();
      
      // ç¯®çƒçº¹è·¯
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(x-15, y);
      ctx.lineTo(x+15, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y-15);
      ctx.lineTo(x, y+15);
      ctx.stroke();
      
      // è¿åŠ¨è½¨è¿¹
      ctx.strokeStyle = "rgba(255,255,255,0.3)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x, y, 25, 0, Math.PI*2);
      ctx.stroke();
    },
    checkCollision: function(x, y, playerX, playerY) {
      const dx = playerX - x;
      const dy = playerY - y;
      return Math.sqrt(dx*dx + dy*dy) < 35;
    }
  },
  threePointLine: { // ä¸‰åˆ†çº¿ï¼ˆéœ€è¦è·³è·ƒï¼‰
    width: 120,
    height: 50,
    color: "#FFD700",
    draw: function(x, y) {
      ctx.strokeStyle = this.color;
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.arc(x, y+25, 60, Math.PI, Math.PI*2);
      ctx.stroke();
      
      // æç¤ºæ–‡å­—
      ctx.fillStyle = "#FFD700";
      ctx.font = "bold 16px Arial";
      ctx.textAlign = "center";
      ctx.fillText("JUMP!", x, y+15);
    },
    checkCollision: function(x, y, playerX, playerY) {
      return Math.abs(playerX - x) < 70 && 
             Math.abs(playerY - (y+25)) < 30 &&
             !player.jumping;
    }
  }
};

function spawnObstacle() {
  if(Math.random() < obstacleSpawnRate) {
    const types = Object.keys(obstacleTypes);
    let type = types[Math.floor(Math.random() * types.length)];
    
    // æ ¹æ®éš¾åº¦è°ƒæ•´éšœç¢ç‰©ç±»å‹
    if(difficultyLevel >= 3) {
      // é«˜éš¾åº¦æ—¶æ›´å¤šç§»åŠ¨ç¯®çƒ
      if(Math.random() < 0.4) type = "movingBall";
    }
    if(difficultyLevel >= 5) {
      // æ›´é«˜éš¾åº¦æ—¶ç»„åˆéšœç¢
      if(Math.random() < 0.3) {
        spawnObstacle(); // è¿ç»­ç”Ÿæˆä¸¤ä¸ª
      }
    }
    
    const lane = lanes[Math.floor(Math.random() * lanes.length)];
    const obstacle = {
      type: type,
      lane: lane,
      y: -100,
      passed: false,
      id: Date.now() + Math.random()
    };
    
    if(type === "movingBall") {
      obstacle.speedX = (Math.random() - 0.5) * 8;
    }
    
    obstacles.push(obstacle);
  }
}

/* ===== å¥–åŠ±ç‰©å“ ===== */
let bonuses = [];
function spawnBonus() {
  if(frame - lastBonusTime > 300 && Math.random() < 0.05) {
    bonuses.push({
      type: Math.random() < 0.7 ? "score" : "speedBoost",
      lane: lanes[Math.floor(Math.random() * lanes.length)],
      y: -50,
      width: 30,
      height: 30
    });
    lastBonusTime = frame;
  }
}

/* ===== è¾“å…¥æ§åˆ¶ ===== */
let touchX = null;
let keys = {};

canvas.addEventListener("touchstart", e => {
  touchX = e.touches[0].clientX;
});

canvas.addEventListener("touchend", e => {
  if(state !== "play") return;
  
  const dx = e.changedTouches[0].clientX - touchX;
  if(Math.abs(dx) > 40) {
    if(dx > 0 && player.lane < 1) player.lane++;
    if(dx < 0 && player.lane > -1) player.lane--;
    touchX = null;
  } else if(!player.jumping) {
    startJump();
  } else if(player.jumping && !player.doubleJumpUsed && 
            characters[selectedCharacter].special === "doubleJump") {
    // äºŒæ®µè·³
    player.jumpT = Math.PI/2;
    player.doubleJumpUsed = true;
  }
});

document.addEventListener("keydown", e => {
  keys[e.key] = true;
  
  if(state === "play") {
    if(e.key === "ArrowLeft" && player.lane > -1) player.lane--;
    if(e.key === "ArrowRight" && player.lane < 1) player.lane++;
    if((e.key === " " || e.key === "ArrowUp") && !player.jumping) {
      startJump();
    }
  }
});

document.addEventListener("keyup", e => {
  keys[e.key] = false;
});

function startJump() {
  player.jumping = true;
  player.jumpT = 0;
  player.doubleJumpUsed = false;
}

/* ===== UIç•Œé¢ ===== */
function renderUI() {
  const ui = document.getElementById("ui");
  const characterSelect = document.getElementById("characterSelect");
  
  if(state === "character") {
    characterSelect.style.display = "block";
    characterSelect.innerHTML = `
      <h2>é€‰æ‹©ä½ çš„è§’è‰²</h2>
      <div style="display:flex;flex-wrap:wrap;justify-content:center;">
        ${Object.keys(characters).map(char => `
          <div class="charOption" onclick="selectCharacter('${char}')">
            <div style="width:100px;height:100px;border-radius:50%;background:${characters[char].color};display:flex;align-items:center;justify-content:center;">
              <div style="width:60px;height:60px;border-radius:50%;background:#fff;"></div>
            </div>
            <h3>${char}</h3>
            <p>ç‰¹æ®Šèƒ½åŠ›: ${
              characters[char].special === "doubleJump" ? "äºŒæ®µè·³" :
              characters[char].special === "fast" ? "å¿«é€Ÿç§»åŠ¨" :
              characters[char].special === "highJump" ? "é«˜è·³" :
              characters[char].special === "slowTime" ? "æ—¶é—´å‡ç¼“" : ""
            }</p>
          </div>
        `).join('')}
      </div>
    `;
    ui.innerHTML = "";
  } else if(state === "start") {
    characterSelect.style.display = "none";
    ui.innerHTML = `
      <h1>ğŸ€ å®¶åº­ç¯®çƒè·‘é…· ğŸ€</h1>
      <p>æ»‘åŠ¨åˆ‡æ¢è½¨é“ Â· ç‚¹å‡»/ç©ºæ ¼è·³è·ƒ Â· é¿å¼€éšœç¢ç‰©</p>
      <button onclick="showCharacterSelect()">é€‰æ‹©è§’è‰²</button>
      <p>æœ€é«˜åˆ†ï¼š${best}</p>
      <p style="font-size:12px;color:#aaa;">ä¸åŒè§’è‰²æœ‰ä¸åŒç‰¹æ®Šèƒ½åŠ›ï¼</p>
    `;
  } else if(state === "over") {
    characterSelect.style.display = "none";
    let comment = "";
    if(score < 50) comment = "ç»§ç»­ç»ƒä¹ ï¼";
    else if(score < 100) comment = "ä¸é”™å“¦ï¼";
    else if(score < 200) comment = "å¤ªæ£’äº†ï¼";
    else comment = "ä½ æ˜¯ç¯®çƒå¤§å¸ˆï¼";
    
    ui.innerHTML = `
      <h2>æ¸¸æˆç»“æŸ</h2>
      <p>å¾—åˆ†ï¼š${score}</p>
      <p>${comment}</p>
      <p>æœ€é«˜åˆ†ï¼š${best}</p>
      <button onclick="showCharacterSelect()">é€‰æ‹©è§’è‰²é‡ç©</button>
      <button onclick="startGame()">å†æ¥ä¸€å±€</button>
    `;
  } else {
    characterSelect.style.display = "none";
    ui.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          è§’è‰²: ${selectedCharacter} | 
          åˆ†æ•°: ${score} | 
          é€Ÿåº¦: ${speed.toFixed(1)} | 
          éš¾åº¦: ${difficultyLevel}
        </div>
        <button onclick="state='over'">æš‚åœ</button>
      </div>
    `;
  }
}

function showCharacterSelect() {
  state = "character";
  renderUI();
}

function selectCharacter(char) {
  selectedCharacter = char;
  startGame();
}

/* ===== æ¸¸æˆé€»è¾‘ ===== */
function startGame() {
  state = "play";
  score = 0;
  speed = 4;
  frame = 0;
  obstacles = [];
  bonuses = [];
  player.lane = 0;
  player.jumping = false;
  player.doubleJumpUsed = false;
  player.specialCooldown = 0;
  difficultyLevel = 1;
  obstacleSpawnRate = 0.18;
  initBuildings();
  renderUI();
}

function updateDifficulty() {
  difficultyLevel = Math.floor(score / 50) + 1;
  speed = 4 + difficultyLevel * 0.5;
  obstacleSpawnRate = 0.18 + difficultyLevel * 0.02;
  
  // åº”ç”¨è§’è‰²ç‰¹æ®Šèƒ½åŠ›
  const char = characters[selectedCharacter];
  if(char.special === "fast") {
    speed += 1;
  } else if(char.special === "slowTime" && player.specialCooldown <= 0) {
    if(score % 100 === 0 && score > 0) {
      speed -= 2;
      player.specialCooldown = 60;
    }
  }
  
  if(player.specialCooldown > 0) player.specialCooldown--;
}

function drawBackground() {
  // å¤©ç©ºæ¸å˜
  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  gradient.addColorStop(0, "#1a237e");
  gradient.addColorStop(1, "#283593");
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // æ˜Ÿæ˜Ÿ
  ctx.fillStyle = "#FFFFFF";
  for(let i = 0; i < 50; i++) {
    const x = (frame * 0.1 + i * 100) % canvas.width;
    const y = (i * 20) % canvas.height;
    ctx.beginPath();
    ctx.arc(x, y, Math.random() * 1.5, 0, Math.PI*2);
    ctx.fill();
  }
  
  // åŸå¸‚å»ºç­‘
  buildings.forEach(building => {
    const x = (building.x - frame * 0.5) % canvas.width;
    if(x + building.width > 0) {
      ctx.fillStyle = building.color;
      ctx.fillRect(x, canvas.height - building.height, building.width, building.height);
      
      // çª—æˆ·
      ctx.fillStyle = "#FFD740";
      for(let i = 0; i < building.windows; i++) {
        const wx = x + 10 + (i % 3) * 20;
        const wy = canvas.height - building.height + 20 + Math.floor(i / 3) * 30;
        if(wy < canvas.height - 30) {
          ctx.fillRect(wx, wy, 8, 12);
        }
      }
    }
  });
  
  // è¡—é“
  ctx.fillStyle = "#424242";
  ctx.fillRect(0, canvas.height * 0.8, canvas.width, canvas.height * 0.2);
  
  // è¡—é“çº¿
  ctx.strokeStyle = "#FFD740";
  ctx.lineWidth = 3;
  ctx.setLineDash([30, 20]);
  ctx.beginPath();
  ctx.moveTo(0, canvas.height * 0.85);
  ctx.lineTo(canvas.width, canvas.height * 0.85);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawPlayer() {
  const char = characters[selectedCharacter];
  let py = player.y;
  
  if(player.jumping) {
    player.jumpT += 0.1;
    const jumpHeight = char.special === "highJump" ? 160 : 120;
    py -= Math.sin(player.jumpT) * jumpHeight;
    if(player.jumpT > Math.PI) {
      player.jumping = false;
      player.doubleJumpUsed = false;
    }
  }
  
  char.draw(laneX(player.lane), py, player.jumping, frame);
  
  // ç‰¹æ®Šèƒ½åŠ›æŒ‡ç¤ºå™¨
  if(char.special === "doubleJump" && player.jumping && !player.doubleJumpUsed) {
    ctx.fillStyle = "#00E5FF";
    ctx.font = "12px Arial";
    ctx.textAlign = "center";
    ctx.fillText("å¯äºŒæ®µè·³", laneX(player.lane), py - 80);
  }
}

function checkCollisions() {
  const playerX = laneX(player.lane);
  const playerY = player.jumping ? 
    player.y - Math.sin(player.jumpT) * 120 : player.y;
  
  // æ£€æŸ¥éšœç¢ç‰©ç¢°æ’
  for(let i = obstacles.length - 1; i >= 0; i--) {
    const obs = obstacles[i];
    const obsX = laneX(obs.lane) + (obs.speedX || 0);
    
    if(!obs.passed && obs.y > playerY - 50 && obs.y < playerY + 50) {
      const type = obstacleTypes[obs.type];
      if(type.checkCollision(obsX, obs.y, playerX, playerY)) {
        gameOver();
        return;
      }
      
      // å¾—åˆ†
      if(obs.y > playerY && !obs.passed) {
        obs.passed = true;
        score += 5;
      }
    }
    
    // ç§»åŠ¨ç¯®çƒçš„æ°´å¹³ç§»åŠ¨
    if(obs.type === "movingBall") {
      obs.lane += obs.speedX / (canvas.width * 0.25);
      if(obs.lane < -1) {
        obs.lane = -1;
        obs.speedX *= -1;
      }
      if(obs.lane > 1) {
        obs.lane = 1;
        obs.speedX *= -1;
      }
    }
    
    // ç§»é™¤è¶…å‡ºå±å¹•çš„éšœç¢ç‰©
    if(obs.y > canvas.height + 100) {
      obstacles.splice(i, 1);
    }
  }
  
  // æ£€æŸ¥å¥–åŠ±ç‰©å“
  for(let i = bonuses.length - 1; i >= 0; i--) {
    const bonus = bonuses[i];
    const bonusX = laneX(bonus.lane);
    
    if(Math.abs(playerX - bonusX) < 40 && 
       Math.abs(playerY - bonus.y) < 40) {
      if(bonus.type === "score") {
        score += 50;
        // å¾—åˆ†ç‰¹æ•ˆ
        ctx.fillStyle = "#FFD700";
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "center";
        ctx.fillText("+50", bonusX, bonus.y);
      } else if(bonus.type === "speedBoost") {
        speed += 2;
        setTimeout(() => { if(speed > 4) speed -= 2; }, 3000);
      }
      bonuses.splice(i, 1);
    }
    
    if(bonus.y > canvas.height + 50) {
      bonuses.splice(i, 1);
    }
  }
}

function gameOver() {
  state = "over";
  best = Math.max(best, score);
  localStorage.bestScore = best;
  renderUI();
}

/* ===== ä¸»æ¸¸æˆå¾ªç¯ ===== */
function gameLoop() {
  requestAnimationFrame(gameLoop);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if(state !== "play") return;
  
  frame++;
  
  // ç»˜åˆ¶èƒŒæ™¯
  drawBackground();
  
  // æ›´æ–°éš¾åº¦
  updateDifficulty();
  
  // ç”Ÿæˆéšœç¢ç‰©å’Œå¥–åŠ±
  if(frame % Math.max(30, 60 - difficultyLevel * 5) === 0) {
    spawnObstacle();
  }
  spawnBonus();
  
  // ç»˜åˆ¶è½¨é“
  ctx.strokeStyle = "rgba(255,255,255,0.3)";
  ctx.lineWidth = 2;
  lanes.forEach(l => {
    ctx.beginPath();
    ctx.moveTo(laneX(l), 0);
    ctx.lineTo(laneX(l), canvas.height);
    ctx.stroke();
  });
  
  // ç»˜åˆ¶ç©å®¶
  drawPlayer();
  
  // æ›´æ–°å’Œç»˜åˆ¶éšœç¢ç‰©
  obstacles.forEach(obs => {
    obs.y += speed;
    const type = obstacleTypes[obs.type];
    const x = laneX(obs.lane) + (obs.speedX || 0);
    type.draw(x, obs.y, frame);
  });
  
  // æ›´æ–°å’Œç»˜åˆ¶å¥–åŠ±ç‰©å“
  bonuses.forEach(bonus => {
    bonus.y += speed;
    ctx.fillStyle = bonus.type === "score" ? "#FFD700" : "#00E5FF";
    ctx.beginPath();
    ctx.arc(laneX(bonus.lane), bonus.y, 15, 0, Math.PI*2);
    ctx.fill();
    
    // å¥–åŠ±å›¾æ ‡
    ctx.fillStyle = "#000";
    ctx.font = "bold 20px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(bonus.type === "score" ? "â˜…" : "âš¡", laneX(bonus.lane), bonus.y);
  });
  
  // æ£€æŸ¥ç¢°æ’
  checkCollisions();
  
  // æ¯å¸§å¾—åˆ†
  score += 0.1;
  
  // æ˜¾ç¤ºå½“å‰åˆ†æ•°ç‰¹æ•ˆ
  if(frame % 30 === 0) {
    ctx.fillStyle = "#FFFFFF";
    ctx.font = "bold 14px Arial";
    ctx.textAlign = "right";
    ctx.fillText(`å¾—åˆ†: ${Math.floor(score)}`, canvas.width - 20, 50);
  }
}

// åˆå§‹åŒ–
renderUI();
gameLoop();

// è§¦æ‘¸åé¦ˆ
canvas.addEventListener("touchstart", () => {
  canvas.style.transform = "scale(0.98)";
  setTimeout(() => {
    canvas.style.transform = "scale(1)";
  }, 100);
});
</script>
</body>
</html>
